<p>Схема базы данных доступна по <a
href="https://dbdiagram.io/d/67c2f944263d6cf9a0e2167a">ссылке.</a></p>
<p>В случае, если есть расхождения с данной схемой, то информация здесь
преобладает над схемой по ссылке.</p>
<h3 id="основные-таблицы">1) Основные таблицы:</h3>
<ul>
<li><strong>User</strong></li>
<li><strong>UserEvent</strong></li>
<li><strong>SubscribeWords</strong></li>
<li><strong>Referral</strong></li>
<li><strong>Invoice</strong></li>
<li><strong>Payment</strong></li>
<li><strong>SubscribePlan</strong></li>
<li><strong>UserSubscribe</strong></li>
<li><strong>Rubric</strong></li>
<li><strong>RubricUserSubscribe</strong></li>
<li><strong>Worker</strong></li>
<li><strong>DigestNews</strong></li>
<li><strong>Channel</strong></li>
<li><strong>ChannelsNews</strong></li>
<li><strong>OpenAiCost</strong></li>
<li><strong>FeedBack</strong> ### 2) Описание таблиц</li>
</ul>
<h3 id="user">User</h3>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о пользователях системы.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (BigInteger, Identity): Уникальный идентификатор
пользователя. Это первичный ключ.</li>
<li><code>user_id</code> (BigInteger, unique): Уникальный идентификатор
пользователя.</li>
<li><code>first_name</code> (Text): Имя пользователя.</li>
<li><code>username</code> (Text): Юзер пользователя.</li>
<li><code>chatgpt_flag</code> (Boolean, default=False): Флаг,
указывающий, включен ли чат-бот GPT для пользователя.</li>
<li><code>created_at</code> (DateTime): Дата и время создания
пользователя.</li>
<li><code>updated_at</code> (DateTime): Дата и время последнего
обновления данных пользователя.</li>
<li><code>balance</code> (Float, default=0.0): Баланс пользователя.(не
используется)</li>
<li><code>media_flag</code> (Boolean, default=True): Флаг, указывающий,
включены ли медиа для пользователя.</li>
<li><code>recommendation_flag</code> (Boolean, default=False): Флаг,
указывающий на активность рекомендации для пользователя.</li>
<li><code>channel_up</code> (Boolean, default=False): Флаг, указывающий,
активирован ли канал пользователя.</li>
<li><code>language</code> (Text, default=“ru”): Язык пользователя.(в
данный момент функция не используется)</li>
<li><code>digest_time</code> (Text): Время получения дайджеста
пользователем.</li>
<li><code>similar_news_filter</code> (Boolean, default=True): Флаг
фильтрации похожих новостей.</li>
<li><code>utm_source</code> (Text): Источник UTM для
пользователя(допустим media, referral).</li>
<li><code>ban_date</code> (DateTime): Дата блокировки бота
пользователем.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>user_id</code>, остальные поля могут быть пустыми. ###
UserEvent</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о событиях, связанных с пользователями.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (BigInteger): Уникальный идентификатор события.</li>
<li><code>user_id</code> (ForeignKey): Внешний ключ, ссылающийся на
пользователя, к которому относится событие.</li>
<li><code>event_type</code> (Text): Тип события.</li>
<li><code>event_timestamp</code> (DateTime, default=func.now() +
timedelta(hours=3)): Время события.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>user_id</code>, <code>event_type</code>. ###
SubscribeWords</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, связывающая подписки пользователей с определенными словами для
фильтрации.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (BigInteger, Identity): Уникальный идентификатор
записи.</li>
<li><code>user_id</code> (ForeignKey): Внешний ключ, ссылающийся на
пользователя.</li>
<li><code>subscribe_id</code> (ForeignKey): Внешний ключ, ссылающийся на
подписку.</li>
<li><code>words</code> (Text): Слова, связанные с подпиской.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>user_id</code>, <code>subscribe_id</code>, <code>words</code>.
### Referral</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о рефералах (приглашенных
пользователях).</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (BigInteger): Уникальный идентификатор.</li>
<li><code>referrer</code> (ForeignKey): Внешний ключ, ссылающийся на
пользователя, который является реферером.</li>
<li><code>referral</code> (ForeignKey): Внешний ключ, ссылающийся на
пользователя, который был приглашен.</li>
<li><code>type</code> (Enum(ReferralType)): Тип реферала (новый,
активный, оплаченный).</li>
<li><code>created_at</code> (DateTime): Дата и время создания
записи.</li>
<li><code>updated_at</code> (DateTime): Дата и время последнего
обновления записи.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>referrer</code>, <code>referral</code>, <code>type</code>. ###
Payment</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о платежах пользователей.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (Integer): Уникальный идентификатор платежа.</li>
<li><code>order_id</code> (String, unique): Идентификатор заказа.</li>
<li><code>amount</code> (Float): Сумма платежа.</li>
<li><code>status</code> (Enum(PaymentStatusType)): Статус платежа.</li>
<li><code>created_at</code> (DateTime): Дата и время создания
записи.</li>
<li><code>updated_at</code> (DateTime): Дата и время последнего
обновления записи.</li>
<li><code>user_id</code> (BigInteger): Идентификатор пользователя.</li>
<li><code>subscribe_type</code> (Enum(SubscribePlanType)): Тип
подписки.</li>
<li><code>days_count</code> (Integer): Количество дней.</li>
<li><code>is_gift</code> (Boolean, default=False): Флаг подарочного
платежа.</li>
<li><code>for_username</code> (String): Логин пользователя, для которого
был осуществлен платеж.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>order_id</code>, <code>amount</code>, <code>status</code>,
<code>user_id</code>, <code>subscribe_type</code>,
<code>days_count</code>. ### SubscribePlan</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о подписках пользователей.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (Integer): Уникальный идентификатор.</li>
<li><code>payment_id</code> (Integer, ForeignKey): Внешний ключ,
ссылающийся на платеж.</li>
<li><code>created_at</code> (DateTime): Дата и время создания
подписки.</li>
<li><code>updated_at</code> (DateTime): Дата и время последнего
обновления подписки.</li>
<li><code>user_id</code> (BigInteger, ForeignKey): Идентификатор
пользователя, связанного с подпиской.</li>
<li><code>paid_by_user_id</code> (BigInteger, ForeignKey): Идентификатор
пользователя, оплатившего подписку.</li>
<li><code>subscribe_type</code> (Enum(SubscribePlanType)): Тип
подписки.</li>
<li><code>days_count</code> (Integer): Количество дней подписки.</li>
<li><code>for_username</code> (String): Логин пользователя.</li>
<li><code>is_gift</code> (Boolean, default=False): Флаг подарочной
подписки.</li>
<li><code>gift_hash</code> (String, unique): Хеш подарочного кода.</li>
<li><code>is_activated</code> (Boolean, default=True): Флаг активации
подписки.</li>
<li><code>start_at</code> (DateTime): Дата начала подписки.</li>
<li><code>expired_at</code> (DateTime): Дата окончания подписки.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>subscribe_type</code>, <code>days_count</code>.</li>
</ul>
<h3 id="usersubscribe">UserSubscribe</h3>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о подписках пользователей на каналы.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (BigInteger, Identity): Уникальный идентификатор
записи.</li>
<li><code>channel_id</code> (BigInteger): Идентификатор канала.</li>
<li><code>user_id</code> (BigInteger): Идентификатор пользователя,
подписавшегося на канал.</li>
<li><code>channel_name</code> (String): Название канала.</li>
<li><code>channel_link</code> (String): Ссылка на канал.</li>
<li><code>last_message_is_sended</code> (Boolean, default=False): Флаг,
указывающий, отправлено ли последнее сообщение.</li>
<li><code>worker_id</code> (Integer, default=2): Идентификатор клиента,
связанного с подпиской.</li>
<li><code>created_at</code> (DateTime): Дата и время создания
подписки.</li>
<li><code>foreign_agent</code> (Boolean, default=False): Флаг,
указывающий, является ли агентом внешний агент.</li>
<li><code>category</code> (String): Категория канала.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>channel_id</code>, <code>user_id</code>,
<code>channel_name</code>, <code>channel_link</code>. ### Rubric</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о рубриках, которые могут быть связаны с
подписками пользователей.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (BigInteger): Уникальный идентификатор рубрики.</li>
<li><code>name</code> (String): Название рубрики.</li>
<li><code>user_id</code> (BigInteger, ForeignKey): Идентификатор
пользователя, который создал рубрику.</li>
<li><code>created_at</code> (DateTime): Дата и время создания
рубрики.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>name</code>, <code>user_id</code>. ###
RubricUserSubscribe</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, связывающая пользователей с рубриками через подписки.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (BigInteger): Уникальный идентификатор записи.</li>
<li><code>user_subscribe_id</code> (BigInteger, ForeignKey):
Идентификатор подписки пользователя.</li>
<li><code>rubric_id</code> (BigInteger, ForeignKey): Идентификатор
рубрики.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>user_subscribe_id</code>, <code>rubric_id</code>. ###
Worker</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о воркерах, их сессиях и других данных.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (Integer): Уникальный идентификатор воркера.</li>
<li><code>session</code> (String): Уникальная сессия воркера.</li>
<li><code>api_id</code> (BigInteger): Идентификатор API воркера.</li>
<li><code>api_hash</code> (String): Хэш API воркера.</li>
<li><code>device_model</code> (String): Модель устройства воркера.</li>
<li><code>system_version</code> (String): Версия операционной
системы.</li>
<li><code>has_proxy</code> (Boolean, default=False): Флаг, указывающий,
используется ли прокси.</li>
<li><code>proxy_type</code> (String, default=“http”): Тип прокси.</li>
<li><code>proxy_address</code> (String): Адрес прокси.</li>
<li><code>proxy_port</code> (Integer): Порт прокси.</li>
<li><code>proxy_username</code> (String): Имя пользователя для
прокси.</li>
<li><code>proxy_password</code> (String): Пароль для прокси.</li>
<li><code>username</code> (Text): Имя воркера.</li>
<li><code>channels_count</code> (Integer, default=0): Количество
каналов, с которыми работает воркера.</li>
<li><code>has_limit</code> (Boolean, default=False): Флаг, указывающий,
есть ли лимит для воркера.</li>
<li><code>is_active</code> (Boolean, default=False): Флаг, указывающий,
активен ли воркера.</li>
<li><code>created_at</code> (DateTime): Дата и время создания записи о
воркера.</li>
<li><code>updated_at</code> (DateTime): Дата и время последнего
обновления воркера.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>session</code>, <code>api_id</code>, <code>api_hash</code>,
<code>device_model</code>, <code>system_version</code>. ###
DigestNews</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о новостях дайджеста, отправленных
пользователям.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (Integer): Уникальный идентификатор новости.</li>
<li><code>user_id</code> (BigInteger): Идентификатор пользователя, для
которого была отправлена новость.</li>
<li><code>text</code> (Text): Текст новости.</li>
<li><code>created_at</code> (DateTime): Дата и время создания
новости.</li>
<li><code>sended</code> (Boolean, default=False): Флаг, указывающий,
была ли новость отправлена.</li>
<li><code>theme</code> (Text): Тема новости.</li>
<li><code>symbol_difference</code> (BigInteger): Разница в
символах.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>text</code>, <code>created_at</code>. ### Channel</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о каналах, которые были напаршены заранее с
помощью tg_stat.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (Integer): Уникальный идентификатор канала.</li>
<li><code>title</code> (Text): Название канала.</li>
<li><code>link</code> (Text): Ссылка на канал.</li>
<li><code>language</code> (Text): Язык канала.</li>
<li><code>category</code> (Text): Категория канала.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>link</code>. ### ChannelsNews(не используется) ###
OpenAiCost</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о стоимости запросов к OpenAI.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (Integer): Уникальный идентификатор записи.</li>
<li><code>user_id</code> (BigInteger): Идентификатор пользователя.</li>
<li><code>type_of_requests</code> (String(255)): Тип запросов к
OpenAI.</li>
<li><code>input_tokens</code> (BigInteger): Количество токенов во
входном запросе.</li>
<li><code>output_tokens</code> (BigInteger): Количество токенов в
ответе.</li>
<li><code>created_at</code> (DateTime): Дата и время создания
записи.</li>
<li><code>cost</code> (Float): Стоимость запроса.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>user_id</code>, <code>type_of_requests</code>,
<code>input_tokens</code>, <code>output_tokens</code>,
<code>cost</code>. ### FeedBack</li>
</ul>
<p><strong>Описание таблицы:</strong><br />
Таблица, хранящая информацию о отзывах пользователей.</p>
<p><strong>Поля:</strong></p>
<ul>
<li><code>id</code> (Integer): Уникальный идентификатор отзыва.</li>
<li><code>user_id</code> (BigInteger): Идентификатор пользователя,
оставившего отзыв.</li>
<li><code>added_channels</code> (Integer): Количество добавленных
каналов.</li>
<li><code>digest_time</code> (Text): Время получения дайджеста.</li>
<li><code>text</code> (Text): Текст отзыва.</li>
<li><code>created_at</code> (DateTime): Дата и время создания
отзыва.</li>
</ul>
<p><strong>Обязательные поля:</strong></p>
<ul>
<li><code>user_id</code>, <code>text</code>.</li>
</ul>
<p>Тут будут идеи</p>
<h2 id="общая-архитектура">1. Общая архитектура</h2>
<p>База данных содержит 16 взаимосвязанных таблиц, реализующих: -
Управление пользователями и их профилями - Систему подписок на каналы и
рубрики - Платежи и реферальную программу - Работу с контентом и
новостными рассылками - Интеграцию с внешними сервисами (Telegram,
OpenAI)</p>
<h2 id="основные-сущности">2. Основные сущности</h2>
<h3 id="пользователи-users">2.1 Пользователи (users)</h3>
<p><strong>Назначение:</strong> Хранение основной информации о
пользователях системы<br />
<strong>Ключевые поля:</strong></p>
<ul>
<li><code>chatgpt_flag</code> - доступ к ChatGPT</li>
<li><code>media_flag</code> - разрешение медиаконтента</li>
<li><code>balance</code> - баланс(не используется, в будущем будет
удален)</li>
<li><code>digest_time</code> - предпочтительное время рассылки</li>
</ul>
<p><strong>Связи:</strong></p>
<ul>
<li>С платежами (payments)</li>
<li>С рефералами (referrals)</li>
<li>С рубриками (rubrics) ### 2.2 Подписки (users_subscribes)</li>
</ul>
<p><strong>Назначение:</strong> Управление подписками пользователей на
Telegram-каналы<br />
<strong>Особенности:</strong></p>
<ul>
<li>Распределение по воркерам (worker_id)</li>
<li>Флаг иностранных агентов(является ли канал иностранным агентом)
(foreign_agent)</li>
<li>Система категорий и рубрик</li>
</ul>
<p><strong>Связи:</strong></p>
<ul>
<li>Многие-ко-многим с rubrics</li>
<li>Связь с workers через worker_id</li>
</ul>
<h3 id="платежи-и-подписки-payments-subscribe_plans">2.3 Платежи и
подписки (payments, subscribe_plans)</h3>
<p><strong>Назначение:</strong> Управление платными подписками и
платежами<br />
<strong>Жизненный цикл:</strong> 1. Создание инвойса (invoices) 2.
Обработка платежа (payments) 3. Активация подписки (subscribe_plans) ###
2.4 Работа с контентом</p>
<p><strong>Каналы (channels):</strong> - Каталог доступных для подписки
каналов - Классификация по языкам и категориям</p>
<p><strong>Новости (channels_news):</strong></p>
<ul>
<li>Архив полученных новостей</li>
<li>Связь с оригинальными постами через link_of_news</li>
</ul>
<p><strong>Дайджесты (digest_news):</strong> - Система отложенной
отправки (sended flag) ## 3. Вспомогательные системы</p>
<h3 id="реферальная-программа-referrals">3.1 Реферальная программа
(referrals)</h3>
<ul>
<li>Трехуровневая система статусов (new/active/paid)</li>
<li>Защита от самоссылок (referrer ≠ referral) ### 3.2 Воркеры
(workers)</li>
</ul>
<p><strong>Назначение:</strong> Управление Telegram-клиентами для сбора
новостей<br />
<strong>Конфигурация:</strong></p>
<ul>
<li>Настройки прокси</li>
<li>Лимиты каналов на воркер</li>
<li>Статистика использования (channels_count) ### 3.3 Аналитика и
метрики</li>
</ul>
<p><strong>UserEvent:</strong><br />
Трекинг действий пользователей (открытие приложения, настройки)</p>
<p><strong>OpenAICost:</strong><br />
Учет расходов на генерацию контента с детализацией:</p>
<ul>
<li>Типы запросов</li>
<li>Использование токенов</li>
<li>Стоимость операций</li>
</ul>
<p><strong>Feedback:</strong><br />
Система сбора обратной связи с привязкой к:</p>
<ul>
<li>Добавленным каналам</li>
<li>Времени рассылки</li>
<li>Произвольным комментариям пользователя ## 4. Бизнес-логика ### 4.1
Механика рекомендаций</li>
</ul>
<ol type="1">
<li>Анализ имеющихся подписок</li>
<li>Учет рубрик и категорий</li>
<li>Фильтрация через similar_news_filter</li>
<li>Формирование персонализированного дайджеста ### 4.2 Модерация
контента</li>
</ol>
<ul>
<li>Автоматическая маркировка foreign_agent</li>
<li>Ручная категоризация каналов</li>
<li>Фильтрация через subscribe_words ## 5. Особенности реализации</li>
</ul>
<p><strong>Временные метки:</strong></p>
<ul>
<li>Все таблицы содержат created_at/updated_at</li>
<li>Автоматическое обновление при изменении записи</li>
<li>Учет московского времени (+3 часа)</li>
</ul>
<p><strong>Безопасность:</strong> - Отдельное хранение платежных данных
(order_id) - Система банов через ban_date - Валидация gift_hash
(уникальные 8-символьные хеши)</p>
<p><strong>Производительность:</strong> - Индексы на внешних ключах -
Партиционирование по датам для channels_news</p>
