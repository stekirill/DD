
**Для управления данными пользователей, подписками, каналами, запросами к OpenAI и аналитикой реализована панель администратора на базе Django. Панель обеспечивает удобный доступ к данным бота и предоставляет гибкие возможности для фильтрации, сортировки, аналитики и управления.**
## Основные возможности

### 1. Статистика (home):

**URL: /  
views.py::home()**

Главная страница (home) отображает ключевые метрики:

- Общее количество пользователей (`User.objects.count()`).
- Пользователи с пробной подпиской (вычисляются через аннотацию Exists для оплаченных счетов).
- Активные подписчики (определяются как пользователи с `ban_date=None`).
- Графики:
	- `stats.get_paid_chart()` — анализ дохода.
	- `stats.get_active_chart()` — активные пользователи.
	- `stats.get_pro_chart()` — пользователи с подпиской.(планы MONTHLY, YEARLY, GIFT, REFERRAL_PAID)
	- `stats.get_new_exit_chart` — **График ушедших / пришедших пользователей:** отображает динамику регистрации и блокировок бота

Реализовано через подзапросы ORM (Subquery, OuterRef, Exists) и сторонние функции из stats.py.


**Связи:**

- С платежами (payments)
- С рефералами (referrals)
- С рубриками (rubrics)
### 2.2 Подписки (users_subscribes)

**Назначение:** Управление подписками пользователей на Telegram-каналы  
**Особенности:**

- Распределение по воркерам (worker_id)
- Флаг иностранных агентов(является ли канал иностранным агентом) (foreign_agent)
- Система категорий и рубрик

**Связи:**

- Многие-ко-многим с rubrics
- Связь с workers через worker_id

### 2.3 Платежи и подписки (payments, subscribe_plans)

**Назначение:** Управление платными подписками и платежами  
**Жизненный цикл:**
1. Создание инвойса (invoices)
2. Обработка платежа (payments)
3. Активация подписки (subscribe_plans)
### 2.4 Работа с контентом

**Каналы (channels):**
- Каталог доступных для подписки каналов
- Классификация по языкам и категориям

**Новости (channels_news):**

- Архив полученных новостей
- Связь с оригинальными постами через link_of_news

**Дайджесты (digest_news):**
- Система отложенной отправки (sended flag)
## 3. Вспомогательные системы

### 3.1 Реферальная программа (referrals)

- Трехуровневая система статусов (new/active/paid)
- Защита от самоссылок (referrer ≠ referral)
### 3.2 Воркеры (workers)

**Назначение:** Управление Telegram-клиентами для сбора новостей  
**Конфигурация:**

- Настройки прокси
- Лимиты каналов на воркер
- Статистика использования (channels_count)
### 3.3 Аналитика и метрики

**UserEvent:**  
Трекинг действий пользователей (открытие приложения, настройки)

**OpenAICost:**  
Учет расходов на генерацию контента с детализацией:

- Типы запросов
- Использование токенов
- Стоимость операций

**Feedback:**  
Система сбора обратной связи с привязкой к:

- Добавленным каналам
- Времени рассылки
- Произвольным комментариям пользователя
## 4. Бизнес-логика
### 4.1 Механика рекомендаций

1. Анализ имеющихся подписок
2. Учет рубрик и категорий
3. Фильтрация через similar_news_filter
4. Формирование персонализированного дайджеста
### 4.2 Модерация контента

- Автоматическая маркировка foreign_agent
- Ручная категоризация каналов
- Фильтрация через subscribe_words
## 5. Особенности реализации

**Временные метки:**

- Все таблицы содержат created_at/updated_at
- Автоматическое обновление при изменении записи
- Учет московского времени (+3 часа)

**Безопасность:**
- Отдельное хранение платежных данных (order_id)
- Система банов через ban_date
- Валидация gift_hash (уникальные 8-символьные хеши)

**Производительность:**
- Индексы на внешних ключах
- Партиционирование по датам для channels_news