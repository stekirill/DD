ывфавфавыфафвыавы## 1. Общая архитектура

База данных содержит 16 взаимосвязанных таблиц, реализующих:
- Управление пользователями и их профилями
- Систему подписок на каналы и рубрики
- Платежи и реферальную программу
- Работу с контентом и новостными рассылками
- Интеграцию с внешними сервисами (Telegram, OpenAI)

## 2. Основные сущности

### 2.1 Пользователи (users)

**Назначение:** Хранение основной информации о пользователях системы  
**Ключевые поля:**

- `chatgpt_flag` - доступ к ChatGPT
- `media_flag` - разрешение медиаконтента
- `balance` - баланс(не используется, в будущем будет удален)
- `digest_time` - предпочтительное время рассылки

**Связи:**

- С платежами (payments)
- С рефералами (referrals)
- С рубриками (rubrics)
### 2.2 Подписки (users_subscribes)

**Назначение:** Управление подписками пользователей на Telegram-каналы  
**Особенности:**

- Распределение по воркерам (worker_id)
- Флаг иностранных агентов(является ли канал иностранным агентом) (foreign_agent)
- Система категорий и рубрик

**Связи:**

- Многие-ко-многим с rubrics
- Связь с workers через worker_id

### 2.3 Платежи и подписки (payments, subscribe_plans)

**Назначение:** Управление платными подписками и платежами  
**Жизненный цикл:**
1. Создание инвойса (invoices)
2. Обработка платежа (payments)
3. Активация подписки (subscribe_plans)
### 2.4 Работа с контентом

**Каналы (channels):**
- Каталог доступных для подписки каналов
- Классификация по языкам и категориям

**Новости (channels_news):**

- Архив полученных новостей
- Связь с оригинальными постами через link_of_news

**Дайджесты (digest_news):**
- Система отложенной отправки (sended flag)
## 3. Вспомогательные системы

### 3.1 Реферальная программа (referrals)

- Трехуровневая система статусов (new/active/paid)
- Защита от самоссылок (referrer ≠ referral)
### 3.2 Воркеры (workers)

**Назначение:** Управление Telegram-клиентами для сбора новостей  
**Конфигурация:**

- Настройки прокси
- Лимиты каналов на воркер
- Статистика использования (channels_count)
### 3.3 Аналитика и метрики

**UserEvent:**  
Трекинг действий пользователей (открытие приложения, настройки)

**OpenAICost:**  
Учет расходов на генерацию контента с детализацией:

- Типы запросов
- Использование токенов
- Стоимость операций

**Feedback:**  
Система сбора обратной связи с привязкой к:

- Добавленным каналам
- Времени рассылки
- Произвольным комментариям пользователя
## 4. Бизнес-логика
### 4.1 Механика рекомендаций

1. Анализ имеющихся подписок
2. Учет рубрик и категорий
3. Фильтрация через similar_news_filter
4. Формирование персонализированного дайджеста
### 4.2 Модерация контента

- Автоматическая маркировка foreign_agent
- Ручная категоризация каналов
- Фильтрация через subscribe_words
## 5. Особенности реализации

**Временные метки:**

- Все таблицы содержат created_at/updated_at
- Автоматическое обновление при изменении записи
- Учет московского времени (+3 часа)

**Безопасность:**
- Отдельное хранение платежных данных (order_id)
- Система банов через ban_date
- Валидация gift_hash (уникальные 8-символьные хеши)

**Производительность:**
- Индексы на внешних ключах
- Партиционирование по датам для channels_news